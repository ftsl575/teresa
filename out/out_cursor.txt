
Краткий отчёт по **Prompt 5 — Implement Rules Engine & Classifier**:

---

## Сделано

### Task 1: `src/rules/rules_engine.py`
- **RuleSet**  
  - Загрузка YAML через `yaml.safe_load(open(..., encoding="utf-8"))`.  
  - Атрибуты: `base_rules`, `service_rules`, `logistic_rules`, `software_rules`, `note_rules`, `config_rules`, `hw_rules`.  
  - `get_state_rules()` возвращает список `state_rules["absent_keywords"]`.  
  - `RuleSet.load(filepath)` — классовый конструктор из файла.  
  - Свойство `version` из YAML.
- **match_rule(row: NormalizedRow, rules: List[dict]) -> Optional[dict]**  
  - Берёт из правила `field` (`module_name` или `option_name`) и `pattern`.  
  - Проверка через `re.search(pattern, value, re.IGNORECASE)`.  
  - Возвращает первый совпавший rule-дикт или `None`.

### Task 2: `src/core/classifier.py`
- **EntityType**: BASE, HW, CONFIG, SOFTWARE, SERVICE, LOGISTIC, NOTE, UNKNOWN.
- **ClassificationResult**: `row_kind`, `entity_type`, `state`, `matched_rule_id`, `warnings`.
- **classify_row(row, ruleset)**  
  - Если `row.row_kind == HEADER` → `entity_type=None`, `state=None`, `matched_rule_id="HEADER-SKIP"`.  
  - Для ITEM: `state = detect_state(row.option_name, ruleset.get_state_rules())`, затем проверки по приоритету: BASE → SERVICE → LOGISTIC → SOFTWARE → NOTE → CONFIG → HW → UNKNOWN.  
  - BASE и NOTE всегда с `state=PRESENT`.

### Task 3: `tests/test_rules_unit.py`
- **21 unit-тест**, в том числе:
  - **test_header_skip** — HEADER → HEADER-SKIP.
  - **test_base_detection** — Base → BASE-001.
  - **test_software_embedded_systems** — Embedded Systems Management → SOFTWARE-001.
  - **test_software_dell_secure_onboarding** — Dell Secure Onboarding → SOFTWARE-002.
  - **test_hw_chassis_config** — Chassis Configuration → HW-001 (не CONFIG).
  - Остальные: BASE (PowerEdge), SOFTWARE (OS Media, License), HW (Processor, TPM), SERVICE (ProSupport, Warranty, NO WARRANTY UPGRADE), LOGISTIC, NOTE, CONFIG, UNKNOWN, state ABSENT/DISABLED.

### Изменение в `rules/dell_rules.yaml`
- В **service_rules** правило **SERVICE-005** (NO WARRANTY UPGRADE) поставлено **перед** общим **SERVICE-003** (Warranty), чтобы «NO WARRANTY UPGRADE SELECTED» матчилось по SERVICE-005. Дубликат SERVICE-003 удалён.

---

## Проверка

```bash
pytest tests/test_rules_unit.py -v
# 21 passed
```

Линтер по затронутым файлам без замечаний. Можно переходить к **Prompt 6 — Diagnostic Artifacts** или к следующему шагу по спецификации.